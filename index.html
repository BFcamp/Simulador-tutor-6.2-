<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Tutor IA - V6 (Oral & Choice)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f6; }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%;
            width: 32px; height: 32px; animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Tabs */
        .tab-button { transition: all 0.2s ease-in-out; border-bottom-width: 3px; border-color: transparent; }
        .tab-button.active { border-color: #2563eb; color: #1d4ed8; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        
        /* Cards & Interactive Elements */
        .mode-card {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 32px; border: 2px solid #e5e7eb; border-radius: 16px; transition: all 0.2s;
            cursor: pointer; text-align: center; background-color: #f9fafb;
        }
        .mode-card:hover {
            border-color: #2563eb; background-color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); transform: translateY(-4px);
        }
        
        /* Progress Bars */
        .progress-bar-container { width: 100%; background-color: #e5e7eb; border-radius: 9999px; height: 12px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background-color: #2563eb; border-radius: 9999px; transition: width 0.5s ease-in-out; }

        /* Choice Mode Styles */
        .mcq-option {
            display: flex; align-items: center; padding: 12px 16px; margin-bottom: 8px;
            border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;
        }
        .mcq-option:hover { background-color: #f3f4f6; }
        .mcq-option.selected { border-color: #2563eb; background-color: #eff6ff; }
        .mcq-option.correct { border-color: #10b981; background-color: #d1fae5; }
        .mcq-option.incorrect { border-color: #ef4444; background-color: #fee2e2; }
        
        .hint-box {
            background-color: #fffbeb; border-left: 4px solid #f59e0b; color: #92400e;
            padding: 12px; margin-top: 12px; font-size: 0.9rem; display: none; border-radius: 4px;
        }

        /* General Reused Styles */
        .qa-card { background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 12px; position: relative; }
        .delete-qa-btn { position: absolute; top: 12px; right: 12px; background: #fee2e2; color: #dc2626; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        
        /* Syllabus Browser Styles */
        .unit-toggle-btn, .topic-toggle-btn { width: 100%; text-align: left; display: flex; justify-content: space-between; align-items: center; padding: 12px; background: transparent; border-bottom: 1px solid #eee; font-weight: 600; }
        .unit-topics-container, .topic-questions-container { display: none; padding-left: 16px; border-left: 2px solid #e5e7eb; }
        .open { display: block; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Modal Sincronizaci칩n -->
    <div id="sync-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50" style="display: none;">
        <div class="bg-white rounded-2xl shadow-xl p-6 max-w-md w-full">
            <h3 class="text-2xl font-bold text-gray-800">Configurar Sincronizaci칩n</h3>
            <p class="mt-3 text-gray-600">Para mantener tus datos, usa el mismo ID en todos tus dispositivos.</p>
            <div class="mt-6">
                <label class="block text-sm font-medium text-gray-700">Tu ID actual o nuevo:</label>
                <input type="text" id="sync-id-input" class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm">
                <button id="save-sync-id" class="mt-3 w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Usar este ID</button>
                <button id="generate-sync-id" class="mt-3 w-full px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700">Generar Nuevo ID</button>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto p-4 sm:p-8">
        
        <!-- Header -->
        <header class="mb-8 bg-white shadow-lg rounded-xl p-6 sm:p-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-2">Simulador Tutor IA</h1>
            <p class="text-lg text-gray-600">Entrenamiento inteligente: Oral, Choice y Repaso Espaciado.</p>
            
            <div class="mt-6 border-t border-gray-200 pt-4">
                <label class="block text-base font-semibold text-gray-800 mb-2">Materia Actual:</label>
                <div class="flex flex-col sm:flex-row sm:space-x-2">
                    <select id="subject-selector" class="w-full sm:w-1/2 p-2.5 border border-gray-300 rounded-lg bg-white">
                        <option value="">-- Cargar Materia --</option>
                    </select>
                    <input type="text" id="new-subject-name" placeholder="Nueva materia..." class="mt-2 sm:mt-0 w-full sm:w-1/2 p-2.5 border border-gray-300 rounded-lg">
                    <button id="add-subject-btn" class="mt-2 sm:mt-0 px-5 py-2.5 bg-gray-800 text-white font-semibold rounded-lg hover:bg-gray-900">Crear</button>
                </div>
            </div>
            <div id="sync-id-display" class="mt-3 text-xs text-gray-500" style="display: none;">
                ID: <span id="user-id" class="font-mono bg-gray-100 p-1 rounded">...</span>
            </div>
        </header>

        <!-- Navegaci칩n Tabs -->
        <div class="mb-6 overflow-x-auto">
            <nav class="flex space-x-6 border-b border-gray-300 min-w-max" aria-label="Tabs">
                <button id="tab-material-btn" class="tab-button active py-4 text-lg font-semibold text-gray-500">Material</button>
                <button id="tab-choice-btn" class="tab-button py-4 text-lg font-semibold text-gray-500">Modo Choice</button>
                <button id="tab-simulador-btn" class="tab-button py-4 text-lg font-semibold text-gray-500">Modo Oral</button>
                <button id="tab-review-btn" class="tab-button py-4 text-lg font-semibold text-gray-500">Repasar (Hoy)</button>
                <button id="tab-units-btn" class="tab-button py-4 text-lg font-semibold text-gray-500">Unidades</button>
                <button id="tab-roadmap-btn" class="tab-button py-4 text-lg font-semibold text-gray-500">Hoja de Ruta</button>
            </nav>
        </div>

        <div class="bg-white shadow-xl rounded-xl p-6 sm:p-8 min-h-[500px]">
            
            <!-- TAB: MATERIAL -->
            <div id="tab-material" class="tab-panel active space-y-6">
                <p class="text-gray-600">Carga aqu칤 la base de conocimiento para la IA. Es fundamental para que clasifique preguntas y detecte temas.</p>
                
                <!-- Syllabus -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-lg font-semibold text-gray-800">Plan de Estudio / Temario</label>
                        <button class="upload-pdf-btn px-3 py-1 bg-blue-100 text-blue-700 text-sm rounded hover:bg-blue-200" data-target="syllabus">Subir PDF</button>
                    </div>
                    <textarea id="syllabus" rows="6" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Copia aqu칤 el programa de la materia..."></textarea>
                </div>
                
                <!-- Theory -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-lg font-semibold text-gray-800">Teor칤a / Apuntes / Libros</label>
                        <button class="upload-pdf-btn px-3 py-1 bg-blue-100 text-blue-700 text-sm rounded hover:bg-blue-200" data-target="theory">Subir PDF</button>
                    </div>
                    <textarea id="theory" rows="8" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Copia aqu칤 apuntes clave o res칰menes..."></textarea>
                </div>

                <!-- Experiences -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-lg font-semibold text-gray-800">Experiencias Orales (Opcional)</label>
                        <button class="upload-pdf-btn px-3 py-1 bg-blue-100 text-blue-700 text-sm rounded hover:bg-blue-200" data-target="experiences">Subir PDF</button>
                    </div>
                    <textarea id="experiences" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Preguntas que hicieron a otros alumnos..."></textarea>
                </div>
                
                <button id="save-material" class="w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-all">Guardar Material en Nube</button>
                <div id="save-status" class="text-center mt-2 font-medium"></div>
            </div>

            <!-- TAB: MODO CHOICE (NUEVO) -->
            <div id="tab-choice" class="tab-panel space-y-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Columna Izquierda: Carga y Lista de Temas -->
                    <div class="lg:col-span-1 space-y-6 border-r border-gray-200 pr-4">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">1. Cargar Ex치menes</h3>
                            <p class="text-sm text-gray-500 mb-2">Sube PDFs de choice o pega preguntas.</p>
                            <div class="flex gap-2 mb-2">
                                <button class="upload-pdf-btn flex-1 py-2 bg-purple-100 text-purple-700 text-sm font-bold rounded hover:bg-purple-200" data-target="choice-raw">Subir PDF Choice</button>
                            </div>
                            <textarea id="choice-raw" rows="4" class="w-full p-2 border border-gray-300 rounded text-sm" placeholder="Pega aqu칤 el texto de los ex치menes..."></textarea>
                            <button id="analyze-choice-btn" class="w-full mt-2 py-2 bg-purple-600 text-white font-bold rounded hover:bg-purple-700 transition-all">
                                Analizar y Clasificar
                            </button>
                        </div>

                        <div id="choice-loader" class="hidden text-center">
                            <div class="loader w-6 h-6 border-2"></div>
                            <p class="text-xs text-gray-500 mt-1">Clasificando y detectando temas flojos...</p>
                        </div>

                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-4">2. Practicar por Tema</h3>
                            <div id="choice-topics-list" class="space-y-2 max-h-[400px] overflow-y-auto pr-2">
                                <p class="text-sm text-gray-400 italic">No hay preguntas analizadas a칰n.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Columna Derecha: Zona de Pr치ctica -->
                    <div class="lg:col-span-2">
                        <div id="choice-practice-area" class="h-full flex flex-col justify-center items-center text-center p-8 bg-gray-50 rounded-xl border border-dashed border-gray-300">
                            <svg data-lucide="check-circle-2" class="w-16 h-16 text-gray-300 mb-4"></svg>
                            <h3 class="text-xl font-semibold text-gray-600">Zona de Pr치ctica</h3>
                            <p class="text-gray-500 max-w-md mt-2">Selecciona un tema de la izquierda para comenzar a practicar las preguntas choice clasificadas.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: MODO ORAL / ESTUDIO -->
            <div id="tab-simulador" class="tab-panel space-y-6">
                <div id="mode-selection" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div id="btn-study-mode" class="mode-card">
                        <svg data-lucide="book-open" class="w-12 h-12 text-blue-600 mb-4"></svg>
                        <h3 class="text-xl font-bold">Modo Estudio Guiado</h3>
                        <p class="text-gray-500 mt-2">Selecciona un tema espec칤fico. La IA te guiar치 con preguntas clave priorizadas.</p>
                    </div>
                    <div id="btn-exam-mode" class="mode-card">
                        <svg data-lucide="swords" class="w-12 h-12 text-red-600 mb-4"></svg>
                        <h3 class="text-xl font-bold">Simulacro Examen</h3>
                        <p class="text-gray-500 mt-2">Preguntas al azar de toda la materia, simulando la presi칩n real.</p>
                    </div>
                </div>

                <!-- Contenedores ocultos para la l칩gica existente (simplificada visualmente) -->
                <div id="study-container" class="hidden">
                    <button id="back-mode-1" class="mb-4 text-sm text-blue-600 font-bold flex items-center"><svg data-lucide="arrow-left" class="w-4 h-4 mr-1"></svg> Volver</button>
                    <h2 class="text-2xl font-bold mb-4">Elige un tema para estudiar:</h2>
                    <div id="syllabus-browser" class="bg-gray-50 p-4 rounded-lg max-h-[400px] overflow-y-auto"></div>
                    <div id="study-output" class="mt-6 space-y-6"></div>
                </div>

                <div id="exam-container" class="hidden">
                    <button id="back-mode-2" class="mb-4 text-sm text-blue-600 font-bold flex items-center"><svg data-lucide="arrow-left" class="w-4 h-4 mr-1"></svg> Volver</button>
                    <div class="bg-white p-6 rounded-lg border border-gray-200 text-center">
                        <label class="font-bold text-gray-700">Cantidad de preguntas:</label>
                        <input type="range" id="exam-qty" min="1" max="5" value="3" class="w-full mt-2">
                        <button id="generate-exam-btn" class="mt-4 px-6 py-2 bg-green-600 text-white font-bold rounded hover:bg-green-700">Generar Preguntas</button>
                    </div>
                    <div id="exam-output" class="mt-6 space-y-6"></div>
                </div>
            </div>

            <!-- TAB: REPASAR (HOY) -->
            <div id="tab-review" class="tab-panel space-y-6">
                <div class="flex justify-between items-center bg-blue-50 p-4 rounded-lg border border-blue-100">
                    <div>
                        <h2 class="text-lg font-bold text-blue-900">Repaso Espaciado (SRS)</h2>
                        <p class="text-sm text-blue-700">Tarjetas programadas para hoy.</p>
                    </div>
                    <div class="text-right">
                        <span id="review-count" class="text-3xl font-extrabold text-blue-600">0</span>
                        <span class="text-xs block text-gray-500">pendientes</span>
                    </div>
                </div>
                <div id="review-list" class="space-y-4 min-h-[200px]">
                    <p class="text-gray-400 text-center py-10">춰Todo al d칤a! No hay tarjetas para repasar hoy.</p>
                </div>
            </div>

            <!-- TAB: UNIDADES -->
            <div id="tab-units" class="tab-panel space-y-6">
                <h2 class="text-xl font-bold text-gray-800">Banco de Preguntas</h2>
                <p class="text-gray-600">Todas tus preguntas (Orales y Flashcards generadas) organizadas.</p>
                <div id="units-progress-ui" class="hidden mb-4">
                    <div class="progress-bar-container"><div id="units-total-bar" class="progress-bar-fill" style="width: 0%"></div></div>
                    <p class="text-xs text-right mt-1 text-gray-500" id="units-total-text">0% completado</p>
                </div>
                <div id="units-list" class="space-y-2"></div>
            </div>

            <!-- TAB: HOJA DE RUTA -->
            <div id="tab-roadmap" class="tab-panel space-y-6">
                <h2 class="text-xl font-bold text-gray-800">Futuro</h2>
                <p class="text-gray-600">Cronograma de tus pr칩ximos repasos.</p>
                <div id="roadmap-list" class="space-y-6"></div>
            </div>

        </div>
    </div>

    <!-- Modal de Error -->
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-sm w-full shadow-2xl">
            <h3 class="text-red-600 font-bold text-lg mb-2">Atenci칩n</h3>
            <p id="error-msg" class="text-gray-700 mb-4"></p>
            <button onclick="document.getElementById('error-modal').style.display='none'" class="w-full py-2 bg-gray-200 font-bold rounded hover:bg-gray-300">Cerrar</button>
        </div>
    </div>

    <!-- Input oculto para PDF -->
    <input type="file" id="hidden-pdf-input" accept=".pdf" style="display: none;">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, onSnapshot, updateDoc, deleteDoc, getDocs, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURACI칍N FIREBASE ---
        const firebaseConfig = {
             apiKey: "AIzaSyAVbIeEAHBfKU5eDqsELTyXkAcM-m5qUUM", // Reemplaza si es necesario
             authDomain: "simulador-examen-oral.firebaseapp.com",
             projectId: "simulador-examen-oral",
             storageBucket: "simulador-examen-oral.firebasestorage.app",
             messagingSenderId: "64722873532",
             appId: "1:64722873532:web:2f708ee4a62366598c34b9"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // --- ESTADO GLOBAL ---
        let userId = localStorage.getItem('my_sync_userId');
        let currentSubject = null;
        let currentTab = 'tab-material';
        let unsubscribeReview = null;
        let unsubscribeRoadmap = null;
        
        // Estado para Modo Choice
        let cachedMcqs = []; 
        let currentPracticeTopic = null;
        let currentPracticeQuestions = [];
        let currentQuestionIndex = 0;

        // --- ELEMENTOS DOM ---
        const els = {
            tabs: document.querySelectorAll('.tab-button'),
            panels: document.querySelectorAll('.tab-panel'),
            subjectSelect: document.getElementById('subject-selector'),
            newSubjectInput: document.getElementById('new-subject-name'),
            addSubjectBtn: document.getElementById('add-subject-btn'),
            pdfInput: document.getElementById('hidden-pdf-input'),
            // Choice
            choiceRaw: document.getElementById('choice-raw'),
            analyzeBtn: document.getElementById('analyze-choice-btn'),
            choiceLoader: document.getElementById('choice-loader'),
            choiceList: document.getElementById('choice-topics-list'),
            practiceArea: document.getElementById('choice-practice-area'),
            // Oral
            studyModeBtn: document.getElementById('btn-study-mode'),
            examModeBtn: document.getElementById('btn-exam-mode'),
            modeSelection: document.getElementById('mode-selection'),
            studyContainer: document.getElementById('study-container'),
            examContainer: document.getElementById('exam-container'),
            syllabusBrowser: document.getElementById('syllabus-browser'),
            // Review
            reviewList: document.getElementById('review-list'),
            reviewCount: document.getElementById('review-count'),
        };

        // --- INICIALIZACI칍N ---
        async function init() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    if (!userId) {
                        document.getElementById('sync-modal').style.display = 'flex';
                    } else {
                        document.getElementById('user-id').textContent = userId;
                        document.getElementById('sync-id-display').style.display = 'block';
                        await loadSubjects();
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }
                }
            });
            await signInAnonymously(auth);
            setupListeners();
        }

        function setupListeners() {
            // Tabs
            els.tabs.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const target = e.target.id.replace('-btn', '');
                    switchTab(target);
                });
            });
            
            // Sync Modal
            document.getElementById('save-sync-id').onclick = () => {
                const val = document.getElementById('sync-id-input').value.trim();
                if(val) { localStorage.setItem('my_sync_userId', val); location.reload(); }
            };
            document.getElementById('generate-sync-id').onclick = () => {
                localStorage.setItem('my_sync_userId', crypto.randomUUID()); location.reload();
            };

            // Subjects
            els.addSubjectBtn.onclick = createSubject;
            els.subjectSelect.onchange = changeSubject;

            // PDF Uploads
            document.querySelectorAll('.upload-pdf-btn').forEach(btn => {
                btn.onclick = () => {
                    els.pdfInput.dataset.target = btn.dataset.target;
                    els.pdfInput.click();
                };
            });
            els.pdfInput.onchange = handlePdfFile;

            // Material Saving
            document.getElementById('save-material').onclick = saveMaterial;

            // Choice Mode
            els.analyzeBtn.onclick = handleAnalyzeChoice;
            
            // Oral Modes
            els.studyModeBtn.onclick = () => { els.modeSelection.classList.add('hidden'); els.studyContainer.classList.remove('hidden'); loadSyllabusBrowser(); };
            els.examModeBtn.onclick = () => { els.modeSelection.classList.add('hidden'); els.examContainer.classList.remove('hidden'); };
            document.getElementById('back-mode-1').onclick = resetModes;
            document.getElementById('back-mode-2').onclick = resetModes;
            document.getElementById('generate-exam-btn').onclick = generateOralExam;
        }

        // --- FUNCIONES CORE ---
        
        function switchTab(tabId) {
            els.tabs.forEach(t => t.classList.remove('active'));
            els.panels.forEach(p => p.classList.remove('active'));
            document.getElementById(tabId + '-btn').classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            if (tabId === 'tab-choice' && currentSubject) loadChoiceTopics();
            if (tabId === 'tab-units' && currentSubject) loadUnitsView();
        }

        async function loadSubjects() {
            const ref = collection(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects');
            const snap = await getDocs(ref);
            els.subjectSelect.innerHTML = '<option value="">-- Seleccionar --</option>';
            snap.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.id; opt.textContent = d.id;
                els.subjectSelect.appendChild(opt);
            });
        }

        async function createSubject() {
            const name = els.newSubjectInput.value.trim();
            if (!name) return;
            await setDoc(doc(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', name), { created: serverTimestamp() });
            await loadSubjects();
            els.subjectSelect.value = name;
            changeSubject();
        }

        function changeSubject() {
            currentSubject = els.subjectSelect.value;
            if (!currentSubject) return;
            
            loadMaterialFields();
            setupReviewListener();
            setupRoadmapListener();
            // Limpiar estados de vistas
            els.choiceList.innerHTML = '';
            els.practiceArea.innerHTML = '<p class="text-gray-400">Selecciona un tema.</p>';
        }

        // --- L칍GICA MATERIAL (PDF & SAVE) ---
        
        async function handlePdfFile(e) {
            const file = e.target.files[0];
            if(!file) return;
            
            const targetId = e.target.dataset.target;
            const textarea = document.getElementById(targetId);
            
            // Notificar carga
            const prevText = textarea.placeholder;
            textarea.placeholder = "Procesando PDF...";
            
            try {
                const buffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(buffer).promise;
                let fullText = "\n\n--- CONTENIDO PDF: " + file.name + " ---\n";
                
                for(let i=1; i<=pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    fullText += content.items.map(item => item.str).join(' ') + "\n";
                }
                
                textarea.value += fullText;
                textarea.placeholder = prevText;
                showError("PDF cargado correctamente (a침adido al final del texto).", false); // Usamos modal error como notify verde si false
            } catch(err) {
                console.error(err);
                showError("Error leyendo PDF. Aseg칰rate de que sea un PDF de texto seleccionable.");
            }
            e.target.value = '';
        }

        async function saveMaterial() {
            if (!currentSubject) return showError("Selecciona una materia.");
            const data = {
                syllabus: document.getElementById('syllabus').value,
                theory: document.getElementById('theory').value,
                experiences: document.getElementById('experiences').value
            };
            // Guardar docs individuales
            for(const [key, val] of Object.entries(data)) {
                await setDoc(doc(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, 'materials', key), { content: val });
            }
            document.getElementById('save-status').textContent = "춰Guardado exitoso!";
            setTimeout(() => document.getElementById('save-status').textContent = '', 3000);
        }

        async function loadMaterialFields() {
            ['syllabus', 'theory', 'experiences'].forEach(async (key) => {
                const d = await getDoc(doc(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, 'materials', key));
                document.getElementById(key).value = d.exists() ? d.data().content : '';
            });
        }

        // --- MODO CHOICE (L칍GICA COMPLETA) ---

        async function handleAnalyzeChoice() {
            const rawText = els.choiceRaw.value;
            if (!rawText.trim()) return showError("No hay texto de examen para analizar.");
            if (!currentSubject) return showError("Selecciona una materia.");

            els.analyzeBtn.disabled = true;
            els.choiceLoader.classList.remove('hidden');

            try {
                // 1. Obtener contexto
                const syllabus = document.getElementById('syllabus').value;
                const theory = document.getElementById('theory').value;

                // 2. Llamada a Gemini para Parsear
                const parsedQuestions = await callGeminiForChoice(rawText, syllabus, theory);

                // 3. Guardar en Firestore (colecci칩n saved_mcq)
                const batchPromises = parsedQuestions.map(q => 
                    addDoc(collection(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, 'saved_mcq'), {
                        ...q,
                        createdAt: serverTimestamp(),
                        status: 'new' // new, mastered
                    })
                );
                await Promise.all(batchPromises);

                // 4. AN츼LISIS DE DEBILIDADES Y GENERACI칍N DE FLASHCARDS (Bonus)
                await analyzeWeaknessesAndGenerateFlashcards(parsedQuestions, syllabus, theory);

                // 5. Refrescar UI
                els.choiceRaw.value = '';
                showError(`춰칄xito! Se clasificaron ${parsedQuestions.length} preguntas. Revisa tambi칠n la pesta침a 'Repasar' para ver las nuevas flashcards de refuerzo.`, false);
                loadChoiceTopics();

            } catch (err) {
                console.error(err);
                showError("Error al analizar: " + err.message);
            } finally {
                els.analyzeBtn.disabled = false;
                els.choiceLoader.classList.add('hidden');
            }
        }

        async function callGeminiForChoice(examText, syllabus, theory) {
            const prompt = `
                Analiza este texto de examen Choice.
                Contexto Syllabus: ${syllabus.substring(0, 3000)}...
                Contexto Teor칤a: ${theory.substring(0, 3000)}...
                
                Texto Examen: ${examText}

                Tarea:
                1. Extrae cada pregunta.
                2. Identifica la opci칩n correcta (si no est치 marcada, ded칰cela del contexto).
                3. Asigna 'topic' (Tema) y 'unit' (Unidad) bas치ndote en el Syllabus.
                4. Escribe una breve 'justification' de la respuesta.
                
                Responde SOLO un JSON Array: [{ "question": "...", "options": ["A", "B",...], "correctAnswer": "Texto opci칩n correcta", "topic": "...", "unit": "...", "justification": "..." }]
            `;
            
            const txt = await callGeminiAPI(prompt, true); // true = force JSON
            try {
                // Intento 1: Parsear directamente
                return JSON.parse(txt);
            } catch (e) {
                // Intento 2: Sanitizar caracteres de control y re-intentar
                console.warn("JSON parse fall칩. Re-intentando con sanitizaci칩n de newlines.");
                // Reemplaza newlines y carriage returns literales por sus versiones escapadas
                const sanitizedTxt = txt.replace(/\n/g, "\\n").replace(/\r/g, "\\r");
                // Dejar que esto falle si vuelve a fallar, para ver el error real
                return JSON.parse(sanitizedTxt); 
            }
        }

        async function analyzeWeaknessesAndGenerateFlashcards(mcqs, syllabus, theory) {
            // 1. Contar frecuencia de temas
            const counts = {};
            mcqs.forEach(q => { counts[q.topic] = (counts[q.topic] || 0) + 1; });
            
            // 2. Top 3 temas m치s frecuentes (asumimos que son los "importantes/flojos")
            const weakTopics = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 3).map(e => e[0]);
            
            if(weakTopics.length === 0) return;

            // 3. Generar Flashcards de memorizaci칩n
            const prompt = `
                Temas d칠biles detectados en el examen: ${weakTopics.join(', ')}.
                Contexto Teor칤a: ${theory.substring(0, 5000)}...
                
                Genera 2 "Flashcards" de memorizaci칩n (Pregunta y Respuesta directa, NO choice) para CADA tema.
                Total 6 tarjetas.
                Formato JSON Array: [{ "topic": "...", "question": "...", "answer": "..." }]
            `;
            
            try {
                const txt = await callGeminiAPI(prompt, true);
                let cards;
                try {
                    // Intento 1: Parsear directamente
                    cards = JSON.parse(txt);
                } catch (e) {
                    // Intento 2: Sanitizar
                    console.warn("JSON parse fall칩 (flashcards). Re-intentando con sanitizaci칩n.");
                    const sanitizedTxt = txt.replace(/\n/g, "\\n").replace(/\r/g, "\\r");
                    cards = JSON.parse(sanitizedTxt);
                }

                // Guardar en saved_questions (Sistema SRS existente)
                const promises = cards.map(c => 
                    addDoc(collection(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, 'saved_questions'), {
                        topic: c.topic,
                        question: c.question,
                        answer: c.answer,
                        unit: "Refuerzo Autom치tico",
                        reviewStep: 0,
                        nextReviewDate: serverTimestamp(), // Disponible ya
                        createdAt: serverTimestamp()
                    })
                );
                await Promise.all(promises);
            } catch(e) { console.warn("Error generando flashcards auto:", e); }
        }

        async function loadChoiceTopics() {
            const q = query(collection(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, 'saved_mcq'));
            const snap = await getDocs(q);
            cachedMcqs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            
            // Agrupar por tema
            const topics = {};
            cachedMcqs.forEach(m => {
                if(!topics[m.topic]) topics[m.topic] = { total: 0, mastered: 0, name: m.topic };
                topics[m.topic].total++;
                if(m.status === 'mastered') topics[m.topic].mastered++;
            });

            els.choiceList.innerHTML = '';
            Object.values(topics).forEach(t => {
                const pct = Math.round((t.mastered / t.total) * 100);
                const div = document.createElement('div');
                div.className = 'p-3 bg-white border rounded hover:bg-gray-50 cursor-pointer transition';
                div.innerHTML = `
                    <div class="flex justify-between mb-1">
                        <span class="font-bold text-sm">${t.name}</span>
                        <span class="text-xs text-gray-500">${t.mastered}/${t.total}</span>
                    </div>
                    <div class="progress-bar-container h-2"><div class="progress-bar-fill" style="width: ${pct}%"></div></div>
                `;
                div.onclick = () => startPractice(t.name);
                els.choiceList.appendChild(div);
            });
        }

        function startPractice(topic) {
            currentPracticeTopic = topic;
            currentPracticeQuestions = cachedMcqs.filter(m => m.topic === topic && m.status !== 'mastered');
            // Si ya complet칩 todo, permitir repasar todo
            if(currentPracticeQuestions.length === 0) currentPracticeQuestions = cachedMcqs.filter(m => m.topic === topic);
            
            // Shuffle simple
            currentPracticeQuestions.sort(() => Math.random() - 0.5);
            currentQuestionIndex = 0;
            renderQuestion();
        }

        function renderQuestion() {
            if(currentQuestionIndex >= currentPracticeQuestions.length) {
                els.practiceArea.innerHTML = `
                    <div class="text-center">
                        <svg data-lucide="trophy" class="w-16 h-16 text-yellow-500 mx-auto mb-4"></svg>
                        <h3 class="text-2xl font-bold">춰Tema Completado!</h3>
                        <button class="mt-4 px-6 py-2 bg-blue-600 text-white rounded" onclick="document.getElementById('tab-choice-btn').click()">Volver a Temas</button>
                    </div>`;
                if (typeof lucide !== 'undefined') lucide.createIcons();
                loadChoiceTopics(); // Actualizar barras
                return;
            }

            const q = currentPracticeQuestions[currentQuestionIndex];
            
            els.practiceArea.innerHTML = `
                <div class="w-full max-w-2xl bg-white p-6 rounded-xl shadow-sm border border-gray-200 text-left">
                    <div class="flex justify-between text-xs text-gray-400 mb-2">
                        <span>${q.topic}</span>
                        <span>Pregunta ${currentQuestionIndex + 1} de ${currentPracticeQuestions.length}</span>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-6">${q.question}</h3>
                    
                    <div id="mcq-options">
                        ${q.options.map(opt => `<div class="mcq-option" onclick="selectOption(this, '${opt.replace(/'/g, "\\'")}')">${opt}</div>`).join('')}
                    </div>

                    <div class="mt-6 flex justify-between items-center">
                        <button id="hint-btn" class="text-sm text-yellow-600 font-semibold flex items-center hover:underline">
                            <svg data-lucide="lightbulb" class="w-4 h-4 mr-1"></svg> Pedir Pista
                        </button>
                        <button id="next-q-btn" class="px-6 py-2 bg-gray-200 text-gray-400 font-bold rounded cursor-not-allowed" disabled>Siguiente</button>
                    </div>
                    
                    <div id="hint-box" class="hint-box"></div>
                    <div id="justification-box" class="mt-4 p-4 bg-blue-50 text-blue-800 rounded hidden text-sm">
                        <strong>Explicaci칩n:</strong> ${q.justification}
                    </div>
                </div>
            `;
            
            // Event Listeners din치micos
            document.getElementById('hint-btn').onclick = () => getHint(q);
            document.getElementById('next-q-btn').onclick = () => {
                currentQuestionIndex++;
                renderQuestion();
            };
            
            // Hacer accesible la funci칩n de selecci칩n
            window.selectOption = (el, text) => checkAnswer(el, text, q);
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        async function getHint(questionData) {
            const box = document.getElementById('hint-box');
            box.style.display = 'block';
            box.textContent = "Generando pista...";
            const prompt = `Dame una pista corta para esta pregunta sin dar la respuesta: "${questionData.question}". Opciones: ${questionData.options.join(',')}`;
            const hint = await callGeminiAPI(prompt, false);
            box.textContent = "游눠 Pista: " + hint;
        }

        async function checkAnswer(el, selectedText, qData) {
            // Deshabilitar clics
            document.querySelectorAll('.mcq-option').forEach(o => o.style.pointerEvents = 'none');
            
            const isCorrect = selectedText.trim() === qData.correctAnswer.trim();
            
            if (isCorrect) {
                el.classList.add('correct');
                // Marcar como mastered en DB
                if (qData.status !== 'mastered') {
                    await updateDoc(doc(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, 'saved_mcq', qData.id), { status: 'mastered' });
                    qData.status = 'mastered'; // Actualizar local
                }
            } else {
                el.classList.add('incorrect');
                // Resaltar la correcta
                const options = document.querySelectorAll('.mcq-option');
                options.forEach(opt => {
                    if (opt.textContent.trim() === qData.correctAnswer.trim()) opt.classList.add('correct');
                });
            }

            // Mostrar justificaci칩n
            document.getElementById('justification-box').classList.remove('hidden');
            
            // Habilitar siguiente
            const nextBtn = document.getElementById('next-q-btn');
            nextBtn.disabled = false;
            nextBtn.classList.remove('bg-gray-200', 'text-gray-400', 'cursor-not-allowed');
            nextBtn.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
        }

        // --- SISTEMA DE REPASO (SRS - L칩gica Anki simplificada) ---

        function setupReviewListener() {
            if (unsubscribeReview) unsubscribeReview();
            const now = new Date();
            const q = query(collection(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, 'saved_questions'), where('nextReviewDate', '<=', now));
            
            unsubscribeReview = onSnapshot(q, (snap) => {
                const cards = snap.docs.map(d => ({id: d.id, ...d.data()}));
                els.reviewCount.textContent = cards.length;
                renderReviewCards(cards);
            });
        }

        function renderReviewCards(cards) {
            els.reviewList.innerHTML = '';
            if (cards.length === 0) {
                els.reviewList.innerHTML = '<div class="text-center py-10 text-green-600 font-bold bg-green-50 rounded">춰Todo repasado por hoy!</div>';
                return;
            }
            
            cards.forEach(card => {
                const div = document.createElement('div');
                div.className = 'qa-card';
                div.innerHTML = `
                    <p class="font-bold text-gray-800 mb-2">${card.question}</p>
                    <div class="answer hidden mt-2 p-3 bg-gray-50 rounded border-l-4 border-blue-500 text-sm text-gray-700">${card.answer}</div>
                    <div class="controls mt-3 flex justify-between items-center">
                        <button class="show-ans-btn text-blue-600 text-sm font-bold">Mostrar Respuesta</button>
                        <div class="rating-btns hidden gap-2">
                            <button class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-bold" data-rate="hard">Dif칤cil (Reset)</button>
                            <button class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-bold" data-rate="good">Bien (+1d)</button>
                            <button class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-bold" data-rate="easy">F치cil (+3d)</button>
                        </div>
                    </div>
                `;
                
                const ansDiv = div.querySelector('.answer');
                const controlsDiv = div.querySelector('.rating-btns');
                const showBtn = div.querySelector('.show-ans-btn');
                
                showBtn.onclick = () => { ansDiv.classList.remove('hidden'); controlsDiv.classList.remove('hidden'); showBtn.classList.add('hidden'); };
                
                div.querySelectorAll('[data-rate]').forEach(btn => {
                    btn.onclick = () => processSRS(card, btn.dataset.rate);
                });
                
                els.reviewList.appendChild(div);
            });
        }

        async function processSRS(card, rating) {
            const intervals = { hard: 0, good: 1, easy: 3 }; // D칤as b치sicos
            let nextDate = new Date();
            let nextStep = card.reviewStep || 0;
            
            if (rating === 'hard') {
                nextStep = 0;
                nextDate.setMinutes(nextDate.getMinutes() + 10); // Repetir pronto
            } else {
                // Algoritmo exponencial simple: step * factor
                const days = rating === 'easy' ? (nextStep === 0 ? 3 : nextStep * 2.5) : (nextStep === 0 ? 1 : nextStep * 1.5); 
                nextDate.setDate(nextDate.getDate() + Math.ceil(days));
                nextStep++;
            }
            
            await updateDoc(doc(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, 'saved_questions', card.id), {
                reviewStep: nextStep,
                nextReviewDate: nextDate
            });
        }

        // --- HOJA DE RUTA ---
        function setupRoadmapListener() {
            if (unsubscribeRoadmap) unsubscribeRoadmap();
            const now = new Date();
            const q = query(
                collection(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, 'saved_questions'),
                where('nextReviewDate', '>', now),
                orderBy('nextReviewDate', 'asc')
            );
            
            unsubscribeRoadmap = onSnapshot(q, (snap) => {
                const container = document.getElementById('roadmap-list');
                container.innerHTML = '';
                if(snap.empty) { container.innerHTML = '<p class="text-gray-400">No hay repasos futuros.</p>'; return; }
                
                snap.forEach(d => {
                    const data = d.data();
                    const date = data.nextReviewDate.toDate().toLocaleDateString();
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-3 bg-white border rounded';
                    div.innerHTML = `<span class="text-sm font-medium">${data.topic || 'General'}</span><span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-600">${date}</span>`;
                    container.appendChild(div);
                });
            });
        }

        // --- MODOS ORALES (Reducidos para brevedad, l칩gica igual) ---
        function loadSyllabusBrowser() {
            // Simplificado: Lee el syllabus y hace lista b치sica
            const text = document.getElementById('syllabus').value;
            const container = document.getElementById('syllabus-browser');
            if(!text) { container.innerHTML = "Carga el syllabus primero."; return; }
            
            // Regex simple para detectar l칤neas cortas como temas
            const lines = text.split('\n').filter(l => l.length > 5 && l.length < 100).slice(0, 10); // Demo top 10 lines
            container.innerHTML = lines.map(l => `<div class="p-2 hover:bg-blue-50 cursor-pointer border-b" onclick="alert('Funci칩n completa en desarrollo: Aqu칤 generar칤amos gu칤a para: ${l}')">${l}</div>`).join('');
        }

        function resetModes() {
            els.studyContainer.classList.add('hidden');
            els.examContainer.classList.add('hidden');
            els.modeSelection.classList.remove('hidden');
        }
        
        async function generateOralExam() {
            // L칩gica similar a la existente
            const out = document.getElementById('exam-output');
            out.innerHTML = "Generando...";
            const prompt = `Genera 3 preguntas de examen oral sobre: ${document.getElementById('syllabus').value.substring(0,1000)}...`;
            const res = await callGeminiAPI(prompt, false);
            out.innerHTML = `<div class="p-4 bg-white border rounded">${res.replace(/\n/g, '<br>')}</div>`;
        }

        // --- UTILS ---
        const API_KEY = "AIzaSyA1RYWX9v5UFVVGVcI9KKyPXK3BDnIRkqw"; // Tu Key Integrada

        async function callGeminiAPI(prompt, expectJson) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
            const body = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: expectJson ? { responseMimeType: "application/json" } : undefined
            };
            
            const resp = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
            const json = await resp.json();
            return json.candidates[0].content.parts[0].text;
        }

        function showError(msg, isError = true) {
            const m = document.getElementById('error-modal');
            const t = document.getElementById('error-msg');
            const h = m.querySelector('h3');
            t.textContent = msg;
            h.textContent = isError ? "Error" : "칄xito";
            h.className = isError ? "text-red-600 font-bold text-lg mb-2" : "text-green-600 font-bold text-lg mb-2";
            m.style.display = 'flex';
        }

        // --- RUN ---
        init();
    </script>
</body>
</html>
